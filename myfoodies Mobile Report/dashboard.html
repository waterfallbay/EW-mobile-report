<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    <meta charset="utf-8" />
    <link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="kendo/styles/kendo.common.min.css" />
    <link rel="stylesheet" href="kendo/styles/kendo.default.min.css" />
    <link rel="stylesheet" href="kendo/styles/kendo.dataviz.min.css" />
    <link rel="stylesheet" href="kendo/styles/kendo.dataviz.default.min.css" />

    <script src="cordova.js"></script>
    <script src="kendo/js/jquery.min.js"></script>
    <script src="kendo/js/kendo.all.min.js"></script>
    <script src="kendo/js/kendo.mobile.min.js"></script>
    
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) --> 
    <!-- Include all compiled plugins (below), or include individual files as needed --> 
    <script src="js/bootstrap.min.js"></script> 
    <script src="js/jasny-bootstrap.min.js"></script>
    <script src="js/jquery.formatCurrency-1.4.0.min.js"></script>
    <script src="js/jquery.dataTables.min.js"></script>
    <script src="js/jquery.cookie.js"></script>
    <script src="js/main.js"></script>
    <script src="lang/lang.js"></script>
    
    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">
    <link href="css/jasny-bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <link href="css/media-query.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<header>
	<div class="navmenu navmenu-default navmenu-fixed-left offcanvas">
      <!--<a class="navmenu-brand" href="#">Project name</a>-->
      <ul class="nav navmenu-nav" id="navbarcontent">
        <li><a href="#" id="menu1"></a></li>
        <li><a href="dashboard2.html" id="menu2"></a></li>
        <li><a href="#" id="menu3"></a></li>
        <li><a href="#" id="menu4"></a></li>
        <li><a href="#" id="menu5"></a></li>
        <li><a href="#" id="menu6"></a></li>
        <li><a href="#" id="menu7"></a></li>
        <li><a href="#" id="menu8"></a></li>
        <li><a href="#" id="menu9"></a></li>
        <li><a href="#" id="menu10"></a></li>
        <li><a href="#" id="menu11"></a></li>
      </ul>
    </div>
    <div class="navbar navbar-default navbar-fixed-top">
      <button type="button" class="navbar-toggle" data-toggle="offcanvas" data-target=".navmenu" data-canvas="body">
        <img src="images/icon-arrow.png" alt="" class="img-responsive">
      </button>
    </div>
    <div class="navbar-top">
    <ul class="head-link">
    <li><a href="#"><figure><img src="images/icon-book.png" alt="" class="img-responsive"></figure></a></li>
    <li><a href="#" id="menuheader1"></a></li>
    </ul>
    <ul class="head-link head-link-right" id="buttonul">
    <li><a href="#" id="toggle-list-view"><figure class="sm"><img src="images/icon-align.png" alt="" class="img-responsive"></figure></a></li>
    <li><a href="#" id="toggle-chart-view"><figure><img src="images/icon-graph.png" alt="" class="img-responsive"></figure></a></li>
    <li><a href="#" data-toggle="modal" data-target="#calendar"><figure><img src="images/icon-calendar.png" alt="" class="img-responsive"></figure></a></li>
    <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown"><figure><img src="images/icon-setting.png" alt="" class="img-responsive"></figure></a>
        <ul class="dropdown-menu" role="menu">
        <li><a href="#" data-toggle="modal" data-target="#restaurantlist" id="selectRestaurant"></a></li>
        <li><a href="#" id="changelang"></a></li>
        <li><a href="#" id="logout"></a></li>
        </ul>
    </li>
    </ul>
    <!--calendar modalbox starts-->
<div class="modal fade" id="calendar" tabindex="-1" role="dialog" aria-labelledby="calendar" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <ul class="lists">
        <li><a href="#">今天</a></li>
        <li><a href="#">過去7天</a></li>
        <li><a href="#">過去30天</a></li>
        <li><a href="#">由本月開始</a></li>
        <li><a href="#">自訂日期範圍</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>
    <!--calendar modalbox ends-->
    <!--restaurantlist modalbox starts-->
    <div class="modal fade" id="restaurantlist" tabindex="-1" role="dialog" aria-labelledby="restaurantlist" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <ul class="lists" id="restaurantlistul">
        </ul>
      </div>
    </div>
  </div>
</div>
    <!--restaurantlist modalbox ends-->
</div>
</header><!--header ends-->
    <!-- section chartview start -->
<section class="wrapper" id="chart-view-section">
	<div class="container">
    	<h1 id="selectedworkday">&nbsp;</h1>
        <h1 class="title" id="shopName">&nbsp;</h1>
        <h4 id="texttitle1"></h4>
        <div class="clearfix"></div>
        <!-- start chart -->
        <div class="chart-wrapper">
           <div id="chart" style="width:100%"></div>
        </div>
        <!-- end chart -->
        <div class="table-responsive">
        	<table class="table table-condensed graph-data" id="amount-table">
            	<tbody>
                	<tr>
                        <td id="emptytd"></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>
    <!-- section chartview end -->
    <!-- section listview start -->
<section class="wrapper" id="list-view-section">
	<div class="container">
    	<h1 id="selectedworkday2">&nbsp;</h1>
        <h1 class="title" id="shopName2">&nbsp;</h1>
        <h4 id="texttitle2"></h4>
        <div class="clearfix"></div>
        <div class="table-responsive">
        	<table id="mydataTable" class="table table-condensed" style="width:100%">
            	
            </table>
        </div>
    </div>
</section>
<!-- section listview end -->
    
    <!--wrapper ends-->
<script>
    
$( "#toggle-list-view" ).click(function( event ) {
  event.preventDefault();
  $( "#chart-view-section" ).hide();
  $( "#list-view-section" ).show();

  $( "#toggle-list-view" ).hide();
  $( "#toggle-chart-view" ).show();
   
});

$( "#toggle-chart-view" ).click(function( event ) {
  event.preventDefault();
  $( "#chart-view-section" ).show();
  $( "#list-view-section" ).hide();
  
  $( "#toggle-chart-view" ).hide();
  $( "#toggle-list-view" ).show();
});
    
var firsttimeenter;
var newshopid;
    
$( document ).ready(function() {
    
    getLangText("zh");
    
    var thisShopId;
    var currenthtmlfile;
    
    currenthtmlfile = document.location.pathname.match(/[^\/]+$/)[0];
    
    $( "#list-view-section" ).hide();
    $( "#toggle-chart-view" ).hide();
    
    $.ajax(
    { 
      type: "GET",
      url: "http://everyware.cloudapp.net/Report/ShopListRest",
      dataType: 'jsonp',
      xhrFields: {
           withCredentials: true
      },
      crossDomain: true,
      success: function(data){
        //alert(data[0].Name);

        console.log ("cookies: "+ $.cookie('shopId'));
        if ($.cookie('shopId') === undefined){
            $.cookie('shopId', thisShopId, {expires:7, path:'/'});
            thisShopId = data[0].ShopId;
            $('#shopName').text(data[0].Name);
            $('#shopName2').text(data[0].Name);
            console.log("thisShopID no cookies: "+thisShopId);
        }
        else{
            thisShopId = $.cookie('shopId');
           
            $.each(data, function(i, item){
                if (data[i].ShopId == thisShopId){
                    $('#shopName').text(data[i].Name);
                    $('#shopName2').text(data[i].Name);
                }
            });
            
            console.log("thisShopID with cookies: "+thisShopId);
        }
        
        
        $.each(data, function(i, item){
            newPath = currenthtmlfile+"?newshopid="+data[i].ShopId;
            $("#restaurantlistul").append('<li><a href="#" onclick="writeNewShopIDCookie('+data[i].ShopId+')">'+data[i].Name+'</a></li>');
        });
            
      },
      error: function (xhr) {
             alert(xhr.responseText);
      }
    }
   );
    
    var moneyArr = [];
    var timeArr =  [];
    var tableArr = [];
    var formattedDatetime;
    var formattedcheckindatetime;
    var formattedcheckoutdatetime;
    var formattedTotalAmount;
    var finalcheckindatetime;
    var finalcheckoutdatetime;
    var maxMoney;
    var hour;
    var minute;
    var selectedworkdaystr;
    var selectedworkdayDay;
    var selectedworkdayMonth;
    var selectedworkdayYear;
    var tableDetailArr = [];
    var finalcheckindatetimeminute;
    var finalcheckoutdatetimeminute;
    
    
    $.ajax(
    {
      type: "GET",
      url: "http://everyware.cloudapp.net/Report/AllTransactionsRest?shop="+getCurrentShopID(),
      dataType: 'jsonp',
      xhrFields: {
           withCredentials: true
      },
      crossDomain: true,
      success: function(data){
          console.log("final ajax shopID: "+thisShopId);
          //update bottom table on dashboard
          maxMoney = parseInt(data.SelectedTxSalesHeaderList[data.SelectedTxSalesHeaderList.length-1].TotalAmountRunningSum+500);
          
          selectedworkdayDay = new Date(parseInt(data.SelectedWorkday.replace("/Date(", "").replace(")/",""), 10)).getDate();
          selectedworkdayMonth = new Date(parseInt(data.SelectedWorkday.replace("/Date(", "").replace(")/",""), 10)).getMonth();
          selectedworkdayYear = new Date(parseInt(data.SelectedWorkday.replace("/Date(", "").replace(")/",""), 10)).getFullYear();
          
          selectedworkdaystr = selectedworkdayYear+yeartext+jsMonthtoNumbermonth(selectedworkdayMonth)+monthtext+selectedworkdayDay+daytext;
          $("#selectedworkday").text(selectedworkdaystr);
          $("#selectedworkday2").text(selectedworkdaystr);
          
          $.each(data.SelectedTxSalesHeaderList, function(i, item) {
              
              formattedcheckindatetime = new Date(parseInt(item.CheckinDatetime.replace("/Date(", "").replace(")/",""), 10)- 1000*3600*8);
              formattedcheckoutdatetime = new Date(parseInt(item.CheckoutDatetime.replace("/Date(", "").replace(")/",""), 10)- 1000*3600*8);
              formattedTotalAmount = "$"+item.AmountTotal;
              
              if(parseInt(formattedcheckindatetime.getMinutes()) <10 ){
                  finalcheckindatetimeminute = "0"+formattedcheckindatetime.getMinutes();
              }
              else{
                  finalcheckindatetimeminute = formattedcheckindatetime.getMinutes();
              }
              
              if(parseInt(formattedcheckoutdatetime.getMinutes()) <10 ){
                  finalcheckoutdatetimeminute = "0"+formattedcheckoutdatetime.getMinutes();
              }
              else{
                  
                  finalcheckoutdatetimeminute = formattedcheckoutdatetime.getMinutes();
              }
              
              
              finalcheckindatetime = formattedcheckindatetime.getHours()+":"+finalcheckindatetimeminute;
              finalcheckoutdatetime = formattedcheckoutdatetime.getHours()+":"+finalcheckoutdatetimeminute;
              
              var tableDetailArr = [item.ReceiptNo , item.TableId , finalcheckindatetime , finalcheckoutdatetime , formattedTotalAmount, item.CashierUserName];
              
              moneyArr.push(item.TotalAmountRunningSum);
              tableArr.push(tableDetailArr);
              formattedDatetime = new Date(parseInt(item.CheckoutDatetime.replace("/Date(", "").replace(")/",""), 10)- 1000*3600*8);

              hour = formattedDatetime.getHours();
              minute = formattedDatetime.getMinutes();
              timeArr.push(new Date("2012/02/01 "+hour+":"+minute+":00"));
           });
          
          createChart(moneyArr, timeArr, maxMoney);
          
          $('#amount-table').printAmountTable(data.TotalSum.SumAmount, data.SelectedPeriodSumModelList);
          
          
          //create jquery datatable
          $('#mydataTable').dataTable({
             "data": tableArr,
             "columns": [
                { "title": invoiceno },
                { "title": tableno },
                { "title": intime },
                { "title": outtime },
                { "title": ttamount},
                { "title": cashierstaff}
                ],
              "paging": false,
              "bFilter": false,
              "info": false
            });
      },
      error: function (xhr) {
             alert(xhr.responseText);
      }
    }
         
    );
    
    $(window).on("resize", function() {
            kendo.resize($(".chart-wrapper"));
    }); 
});

(function($){
    $.fn.extend({
        printAmountTable: function(thisumamount, timesectiondata) {
            
            $("td#emptytd").parent().replaceWith('<tr><td><span class="large" id="total-wholeday">'+whodaytext+'</span></td><td><span class="large large-txt" id="WholeDaySum"></span></td></tr>');
            //$("#amount-table tr:last").after('<tr><td><span class="large" id="total-wholeday">全日</span></td><td><span class="large large-txt" id="WholeDaySum"></span></td></tr>');
  
            $("#WholeDaySum").text(thisumamount).formatCurrency();
            
            //alert(timesectiondata.length);
            for (i = 0; i < timesectiondata.length; i++) { 
                 $('#amount-table tr:last').after('<tr><td><span>'+timesectiondata[i].PeriodName+'</span></td><td><div id="timesectionspan'+i+'">&nbsp;</div></td></tr>');
                 $('#timesectionspan'+i).text(timesectiondata[i].SumAmount).formatCurrency();
             }
            return;
        }
    });
})(jQuery);
    
function createChart(moneyArr , timeArr , maxMoney) {
            $("#chart").kendoChart({
                legend: {
                    visible: false
                },
                seriesDefaults: {
                    type: "line",
                    missingValues: "gap",
                    stack: true
                },
                series: [{
                    name: "營業額",
                    data: moneyArr,
                    color: "#f3ac32"
                }],
                valueAxis: {
                    max: maxMoney,
                    line: {
                        visible: false
                    },
                    minorGridLines: {
                        visible: true
                    }
                },
                categoryAxis: {
                    categories: timeArr,
                    baseUnit: "hours",
                    autoBaseUnitSteps: {
                        hours: [3]
                    },
                    majorGridLines: {
                        visible: false
                    },
                labels: {
                   dateFormats: {
                        hours: "H"
                        }
                    }
                },
                tooltip: {
                    visible: true,
                    template: "#= series.name #: #= value #"
                }
            });
        }
    
function jsMonthtoNumbermonth(num){
    
    var month = [];
    
    month[0] = "1";
    month[1] = "2";
    month[2] = "3";
    month[3] = "4";
    month[4] = "5";
    month[5] = "6";
    month[6] = "7";
    month[7] = "8";
    month[8] = "9";
    month[9] = "10";
    month[10] = "11";
    month[11] = "12";
    realnummonth = month[num];
    
    return realnummonth; 
}

function writeNewShopIDCookie(ShopID){
    $.cookie('shopId', ShopID, {expires:7, path:'/'});
    console.log("cookie is chaing to: " + $.cookie('shopId'));
    window.location.replace("dashboard.html");
}

function getCurrentShopID()
{
    currentShopID = $.cookie('shopId');
    
    return currentShopID;
}
</script>
</body>
</html>